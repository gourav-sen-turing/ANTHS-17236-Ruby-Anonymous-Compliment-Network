<%= turbo_frame_tag "new_compliment_form" do %>
  <%= form_with(model: compliment,
    class: "compliment-form",
      data: { controller: "compliment-form" }) do |form| %>

      <% if compliment.errors.any? %>
      <div>
        <h2>
          <%= pluralize(compliment.errors.count, "error") %> prevented this compliment from being sent:
        </h2>
        <ul>
          <% compliment.errors.full_messages.each do |message| %>
          <li>
            <%= message %>

          </li>
          <% end %>
        </ul>
      </div>
      <% end %>
      <div>
        <!-- Recipient Selection -->
        <div class="form-group">
          <%= form.label :recipient_id, "Send To", class: "block text-sm font-medium text-gray-700 mb-1" %>

          <div data-controller="recipient-select">
            <div class="relative">
              <input type="text"
              class="form-input block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 rounded-md"
              placeholder="Search by name or username"
              data-action="input->recipient-select#search"
              data-recipient-select-target="searchInput">

              <!-- Hidden actual form field that stores the ID -->
              <%= form.hidden_field :recipient_id, data: { recipient_select_target: "hiddenInput", compliment_form_target: "recipient" } %>

              <!-- Selected recipient display (shown when a recipient is selected) -->
              <div class="selected-recipient hidden mt-2 flex items-center bg-indigo-50 p-2 rounded-md"
              data-recipient-select-target="selectedDisplay">
              <span data-recipient-select-target="selectedName" class="flex-grow"></span>

              <button>
                recipient-select#clearSelection">

                <svg>
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
              </button>
            </div>
            <!-- Dropdown for search results -->
            <div>
              <!-- Results will be inserted here by Stimulus controller -->
            </div>
          </div>
        </div>
      </div>

      <!-- Category Selection -->
      <div>
        <%= form.label :category_id, "Message Type", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.collection_select :category_id, Category.where(system: true).order(:name), :id, :name, { prompt: "Select a category" }, { class: "form-select" } %>
          <p>
            Choose the type of message you'd like to send.
          </p>
        </div>
        <!-- Template Suggestions -->
        <div>
          <p>
            Suggested starters:

          </p>
          <div class="template-options flex flex-wrap gap-2"
          data-compliment-form-target="templates">
          <!-- Templates will be inserted here by Stimulus Controller -->
        </div>
      </div>

      <!-- Compliment Content -->
      <div>
        <%= form.label :content, "Your Message", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.text_area :content,
        rows: 5,
        class: "form-textarea block w-full px-3 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 rounded-md",
         placeholder: "Write your compliment here...",
         data: {
           compliment_form_target: "content",
           action: "input->compliment-form#updateCharacterCount"
         } %>
         <div class="flex justify-between items-center mt-1">
          <div class="character-count text-sm text-gray-500" data-compliment-form-target="characterCount">
            0/500 characters
          </div>
          <!-- Content validation status/icons could go here -->
        </div>
      </div>

      <!-- Anonymity Option -->
      <div>
        <div class="flex items-start">
          <div class="flex items-center h-5">
            <%= form.check_box :anonymous,
            class: "h-4 w-4 text-indigo-600 border-gray-300 rounded",
              data: { compliment_form_target: "anonymous" } %>
            </div>
            <div>
              <%= form.label :anonymous, "Send anonymously", class: "font-medium text-gray-700" %>
              <p>
                When checked, the recipient won't know who sent this message.
              </p>
            </div>
          </div>
        </div>

        <!-- Community Association (if applicable) -->
        <% if current_user.communities.any? %>
        <div>
          <%= form.label :community_id, "Share with Community", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= form.collection_select :community_id,
          current_user.communities,
          :id,
          :name,
          { prompt: "None - keep private between recipient and me" },
          class: "form-select block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 rounded-md" %>
          <p>
            Optionally share this compliment with a community feed.
          </p>
        </div>
        <% end %>

        <!-- Form Actions -->
        <div>
          <%= link_to "Cancel", dashboard_path, class: "btn-secondary px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" %>
          <%= form.submit "Send Compliment",
          class: "btn-primary px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
        </div>
      </div>
  <% end %>
<% end %>
